# SimPy ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹å‡¦ç†ãƒ•ãƒ­ãƒ¼

**æ¦‚è¦**: SimPyã‚’ä½¿ç”¨ã—ãŸãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®å‡¦ç†ãƒ•ãƒ­ãƒ¼ã¨ãƒªã‚¯ã‚¨ã‚¹ãƒˆçµŒè·¯ã®è©³ç´°

---

## ğŸ—ï¸ ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆ

```mermaid
graph TB
    Client[ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ] --> Nginx[Nginx<br/>8threads, 16GB RAM]
    Nginx --> APP1[APP1<br/>16threads, 64GB RAM]
    APP1 --> Auth[Auth<br/>4threads, 32GB RAM]
    APP1 --> Policy[Policy<br/>8threads, 32GB RAM]
    APP1 --> Service[Service<br/>16threads, 64GB RAM]
    
    Service -->|30%ç¢ºç‡| DB[DB<br/>32threads, 128GB RAM]
    Service --> ServiceHub[ServiceHub<br/>16threads, 64GB RAM]
    ServiceHub --> APP2[APP2<br/>16threads, 64GB RAM]
    
    Service -.->|éåŒæœŸ| Logger[Logger<br/>4threads, 16GB RAM]
    Logger -.-> S3[S3<br/>4threads, 32GB RAM]
    
    style Auth fill:#ffcccc
    style Service fill:#ccffcc
    style Logger fill:#ccccff
```

---

## ğŸ”„ ãƒ¡ã‚¤ãƒ³ãƒªã‚¯ã‚¨ã‚¹ãƒˆå‡¦ç†ãƒ•ãƒ­ãƒ¼

### **Phase 1: ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ**
```
1. Nginxå‡¦ç†
   â”œâ”€â”€ CPU: 10ms
   â”œâ”€â”€ Network: 1MB
   â””â”€â”€ å½¹å‰²: ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚·ãƒ³ã‚°ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆæŒ¯ã‚Šåˆ†ã‘
```

### **Phase 2: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å‡¦ç†**
```
2. APP1å‡¦ç†
   â”œâ”€â”€ CPU: 60ms
   â”œâ”€â”€ RAM: 2GBç¢ºä¿
   â””â”€â”€ å½¹å‰²: åˆæœŸãƒªã‚¯ã‚¨ã‚¹ãƒˆå‡¦ç†ã€èªè¨¼æº–å‚™
```

### **Phase 3: ä¸¦åˆ—èªè¨¼ãƒ»èªå¯å‡¦ç†** âš¡
```
3a. Authå‡¦ç† (ä¸¦åˆ—)          3b. Policyå‡¦ç† (ä¸¦åˆ—)         3c. Serviceå‡¦ç† (ä¸¦åˆ—)
    â”œâ”€â”€ CPU: 40ms               â”œâ”€â”€ CPU: 30ms                â”œâ”€â”€ CPU: 80ms
    â”œâ”€â”€ RAM: 1GB                â”œâ”€â”€ RAM: 1GB                 â”œâ”€â”€ RAM: 2GB
    â””â”€â”€ å¿…é ˆï¼šå®Œäº†å¾…ã¡           â””â”€â”€ å¿…é ˆï¼šå®Œäº†å¾…ã¡            â””â”€â”€ ç‹¬ç«‹ï¼šå¾Œã§å¾…æ©Ÿ

    â†“ åŒæ™‚å®Ÿè¡Œ â†“               â†“ åŒæ™‚å®Ÿè¡Œ â†“                â†“ æ¡ä»¶åˆ†å² â†“
    
Auth/Policyå®Œäº†ã¾ã§å¾…æ©Ÿ                                   30%ç¢ºç‡ã§DBå‘¼ã³å‡ºã—
system.env.all_of([auth_task, policy_task])              â”œâ”€â”€ CPU: 120ms
                                                         â”œâ”€â”€ RAM: 4GB  
                                                         â”œâ”€â”€ Disk: 50MB
                                                         â””â”€â”€ Network: 2MB
```

### **Phase 4: ã‚µãƒ¼ãƒ“ã‚¹å®Œäº†å¾…ã¡**
```
4. Serviceå‡¦ç†å®Œäº†å¾…ã¡
   â””â”€â”€ yield service_task
       â”œâ”€â”€ Serviceã®ã¿ã®å‡¦ç†å®Œäº†
       â””â”€â”€ DBå‡¦ç†ï¼ˆå®Ÿè¡Œã•ã‚ŒãŸå ´åˆï¼‰å®Œäº†
```

### **Phase 5: éåŒæœŸãƒ­ã‚°å‡¦ç†é–‹å§‹** ğŸ”„
```
5. éåŒæœŸãƒ­ã‚°é–‹å§‹ï¼ˆãƒ¡ã‚¤ãƒ³å‡¦ç†ã«å½±éŸ¿ã—ãªã„ï¼‰
   system.env.process(logger_to_s3_flow(system))
   
   5a. Loggerå‡¦ç†              5b. S3å‡¦ç†
       â”œâ”€â”€ CPU: 20ms               â”œâ”€â”€ CPU: 10ms
       â”œâ”€â”€ RAM: 1GB                â”œâ”€â”€ RAM: 2GB
       â””â”€â”€ éåŒæœŸå®Ÿè¡Œ              â”œâ”€â”€ Disk: 100MB
                                   â”œâ”€â”€ Network: 20MB
                                   â””â”€â”€ éåŒæœŸå®Ÿè¡Œ
```

### **Phase 6: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å‡¦ç†**
```
6. ServiceHubå‡¦ç†
   â”œâ”€â”€ CPU: 50ms
   â”œâ”€â”€ RAM: 1GB
   â””â”€â”€ å½¹å‰²: ã‚µãƒ¼ãƒ“ã‚¹çµ±åˆã€ãƒ‡ãƒ¼ã‚¿é›†ç´„
```

### **Phase 7: æœ€çµ‚å‡¦ç†**
```
7. APP2æœ€çµ‚å‡¦ç†
   â”œâ”€â”€ CPU: 40ms
   â”œâ”€â”€ RAM: 2GB
   â”œâ”€â”€ å½¹å‰²: ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ•´å½¢ã€æœ€çµ‚æ¤œè¨¼
   â””â”€â”€ å®Œäº†ï¼šã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¸ãƒ¬ã‚¹ãƒãƒ³ã‚¹
```

---

## âš¡ ä¸¦åˆ—å‡¦ç†ã®è©³ç´°

### **åŒæœŸä¸¦åˆ—å‡¦ç†ï¼ˆPhase 3ï¼‰**
```python
# 3ã¤ã®å‡¦ç†ã‚’åŒæ™‚é–‹å§‹
auth_task = system.env.process(system.auth.process_request(cpu_ms=40, ram_gb=1))
policy_task = system.env.process(system.policy.process_request(cpu_ms=30, ram_gb=1))
service_task = system.env.process(service_with_db_flow(system))

# Auth/Policyå®Œäº†ã¾ã§å¾…æ©Ÿï¼ˆå¿…é ˆï¼‰
yield system.env.all_of([auth_task, policy_task])

# Serviceå®Œäº†å¾…ã¡ï¼ˆç‹¬ç«‹ï¼‰
yield service_task
```

**åŠ¹æœ**:
- Auth(40ms) + Policy(30ms) = æœ€å¤§40msã§å®Œäº†ï¼ˆé€æ¬¡ãªã‚‰70msï¼‰
- **æ™‚é–“çŸ­ç¸®**: ç´„43%ã®å‡¦ç†æ™‚é–“å‰Šæ¸›

### **éåŒæœŸå‡¦ç†ï¼ˆPhase 5ï¼‰**
```python
# ãƒ¡ã‚¤ãƒ³å‡¦ç†ã«å½±éŸ¿ã•ã›ãšã«ãƒ­ã‚°å‡¦ç†é–‹å§‹
system.env.process(logger_to_s3_flow(system))
# â†‘ yield ã—ãªã„ = å¾…æ©Ÿã—ãªã„
```

**åŠ¹æœ**:
- Logger(20ms) + S3(10ms + Disk/Network) ãŒãƒ¡ã‚¤ãƒ³å‡¦ç†æ™‚é–“ã«åŠ ç®—ã•ã‚Œãªã„
- **ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“**: ãƒ­ã‚°å‡¦ç†åˆ†ï¼ˆ~100msï¼‰ã®çŸ­ç¸®

---

## ğŸ¯ æ¡ä»¶åˆ†å²å‡¦ç†

### **Service â†’ DB å‘¼ã³å‡ºã—ï¼ˆ30%ç¢ºç‡ï¼‰**
```python
def service_with_db_flow(system):
    # Serviceå‡¦ç†ï¼ˆå¿…é ˆï¼‰
    yield system.env.process(system.service.process_request(cpu_ms=80, ram_gb=2))
    
    # 30%ã®ç¢ºç‡ã§DBå¿…è¦
    if random.random() < 0.3:
        yield system.env.process(system.db.process_request(
            cpu_ms=120, ram_gb=4, disk_mb=50, net_mb=2
        ))
```

**å®Ÿè¡Œãƒ‘ã‚¿ãƒ¼ãƒ³**:
- **70%ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**: Serviceå‡¦ç†ã®ã¿ï¼ˆ80msï¼‰
- **30%ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**: Service + DBå‡¦ç†ï¼ˆ80ms + 120ms + Disk/Networkï¼‰

---

## â±ï¸ ã‚¿ã‚¤ãƒŸãƒ³ã‚°å›³

```
æ™‚é–“è»¸ â†’  0ms    50ms   100ms  150ms  200ms  250ms  300ms  350ms
         â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¤

Nginx    [â– â– ]
         â””â”€â†’ APP1    [â– â– â– â– â– â– ]
                     â””â”€â†’ Auth     [â– â– â– â– ] â†â”
                     â””â”€â†’ Policy   [â– â– â– ]   â”‚ ä¸¦åˆ—å®Ÿè¡Œ
                     â””â”€â†’ Service  [â– â– â– â– â– â– â– â– ] â†â”˜
                                 â””â”€â†’ DB (30%) [â– â– â– â– â– â– â– â– â– â– â– ]
                                           â””â”€â†’ ServiceHub [â– â– â– â– â– ]
                                                      â””â”€â†’ APP2 [â– â– â– â– ]

Logger   (éåŒæœŸ)                 [â– â– ] â”€â”€â†’ S3 [â– â– â– â– â– â– â– â– â– ]

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ãƒ¡ã‚¤ãƒ³å‡¦ç†æ™‚é–“: ~250-350ms (DBã‚¢ã‚¯ã‚»ã‚¹æœ‰ç„¡ã«ã‚ˆã‚‹)
ãƒ­ã‚°å‡¦ç†æ™‚é–“: ãƒ¡ã‚¤ãƒ³å‡¦ç†ã«å½±éŸ¿ã›ãšï¼ˆéåŒæœŸï¼‰
```

---

## ğŸ“Š ãƒªã‚½ãƒ¼ã‚¹æ¶ˆè²»ãƒ‘ã‚¿ãƒ¼ãƒ³

### **CPUä½¿ç”¨é‡ï¼ˆãƒªã‚¯ã‚¨ã‚¹ãƒˆå½“ãŸã‚Šï¼‰**
| ã‚µãƒ¼ãƒãƒ¼ | CPUæ™‚é–“ | ä½¿ç”¨ç‡è¨ˆç®— | å‚™è€ƒ |
|---------|---------|-----------|------|
| Nginx | 10ms | ä½è² è· | ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å‡¦ç†ãƒ¡ã‚¤ãƒ³ |
| APP1 | 60ms | ä¸­è² è· | ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å‡¦ç† |
| Auth | 40ms | **é«˜è² è·** | 4ã‚¹ãƒ¬ãƒƒãƒ‰ã§ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ |
| Policy | 30ms | ä¸­è² è· | 8ã‚¹ãƒ¬ãƒƒãƒ‰ã§å‡¦ç† |
| Service | 80ms | ä¸­è² è· | 16ã‚¹ãƒ¬ãƒƒãƒ‰ã§åˆ†æ•£ |
| DB | 120ms (30%ç¢ºç‡) | ä¸­è² è· | 32ã‚¹ãƒ¬ãƒƒãƒ‰ã§é«˜æ€§èƒ½ |
| ServiceHub | 50ms | ä¸­è² è· | ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å‡¦ç† |
| APP2 | 40ms | ä¸­è² è· | æœ€çµ‚å‡¦ç† |

### **ãƒ¡ãƒ¢ãƒªä½¿ç”¨ãƒ‘ã‚¿ãƒ¼ãƒ³**
```
ãƒªã‚¯ã‚¨ã‚¹ãƒˆé–‹å§‹æ™‚:
â”œâ”€â”€ APP1: 2GBç¢ºä¿
â”œâ”€â”€ Auth: 1GBç¢ºä¿  
â”œâ”€â”€ Policy: 1GBç¢ºä¿
â””â”€â”€ Service: 2GBç¢ºä¿
    â””â”€â”€ DB (30%): 4GBç¢ºä¿

éåŒæœŸå‡¦ç†:
â”œâ”€â”€ Logger: 1GBç¢ºä¿
â””â”€â”€ S3: 2GBç¢ºä¿

æœ€çµ‚å‡¦ç†:
â”œâ”€â”€ ServiceHub: 1GBç¢ºä¿  
â””â”€â”€ APP2: 2GBç¢ºä¿
```

---

## ğŸš¨ ãƒœãƒˆãƒ«ãƒãƒƒã‚¯åˆ†æ

### **1. Authã‚µãƒ¼ãƒãƒ¼ï¼ˆæœ€å¤§ã®å•é¡Œï¼‰**
```
å•é¡Œ: 4ã‚¹ãƒ¬ãƒƒãƒ‰ Ã— 40ms/ãƒªã‚¯ã‚¨ã‚¹ãƒˆ = 100mså‘¨æœŸã§4ãƒªã‚¯ã‚¨ã‚¹ãƒˆå‡¦ç†
ç†è«–é™ç•Œ: 4 Ã— (1000ms / 40ms) = 100 req/s
å®Ÿæ¸¬å€¤: ~100 req/sã§99%CPUä½¿ç”¨ç‡

å¯¾ç­–: threads 4â†’16 ã§ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆ4å€å‘ä¸Š
```

### **2. S3ã‚µãƒ¼ãƒãƒ¼ï¼ˆRAMä¸è¶³ï¼‰**
```
å•é¡Œ: 32GB RAM Ã— éåŒæœŸå¤§é‡å‡¦ç† = ãƒ¡ãƒ¢ãƒªä¸è¶³
ç¾è±¡: å…¨è² è·ãƒ¬ãƒ™ãƒ«ã§100%RAMä½¿ç”¨ç‡
å½±éŸ¿: ãƒ­ã‚°å‡¦ç†é…å»¶ã€ãƒ¡ãƒ¢ãƒªã‚¹ãƒ¯ãƒƒãƒ—

å¯¾ç­–: ram_gb 32â†’128 ã§ä½™è£•ç¢ºä¿
```

### **3. Service + DBï¼ˆæ¡ä»¶åˆ†å²ã®å½±éŸ¿ï¼‰**
```
Serviceå˜ä½“: 80mså‡¦ç†
Service + DB: 80ms + 120ms + Disk/Network = ~250mså‡¦ç†

30%ç¢ºç‡ã§ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“ãŒ3å€ã«å»¶é•·
é«˜è² è·æ™‚ã«DBå¾…ã¡ã‚­ãƒ¥ãƒ¼ãŒç™ºç”Ÿ

å¯¾ç­–: DBã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ¼ãƒ«ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥å°å…¥
```

---

## ğŸ’¡ æœ€é©åŒ–ææ¡ˆ

### **çŸ­æœŸå¯¾ç­–ï¼ˆå³åº§ã«å®Ÿè£…å¯èƒ½ï¼‰**
1. **Authå¼·åŒ–**: `threads=4` â†’ `threads=16`, `ram_gb=32` â†’ `ram_gb=64`
2. **S3å¼·åŒ–**: `ram_gb=32` â†’ `ram_gb=128`  
3. **Serviceèª¿æ•´**: DBæ¥ç¶šæœ€é©åŒ–ã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š

### **ä¸­æœŸå¯¾ç­–ï¼ˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ”¹å–„ï¼‰**
1. **Authåˆ†æ•£**: è¤‡æ•°Authã‚µãƒ¼ãƒãƒ¼ã§ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚·ãƒ³ã‚°
2. **éåŒæœŸå‡¦ç†æ”¹å–„**: ãƒ­ã‚°å‡¦ç†ã®ãƒãƒƒãƒåŒ–ã€ã‚­ãƒ¥ãƒ¼ã‚¤ãƒ³ã‚°
3. **DBæœ€é©åŒ–**: ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥å±¤è¿½åŠ 

### **é•·æœŸå¯¾ç­–ï¼ˆã‚·ã‚¹ãƒ†ãƒ å†è¨­è¨ˆï¼‰**
1. **ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹åˆ†å‰²**: Serviceæ©Ÿèƒ½ã®ç´°åˆ†åŒ–
2. **ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•**: å®Œå…¨éåŒæœŸã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¸ç§»è¡Œ
3. **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£**: å‹•çš„ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°å¯¾å¿œ

---

**é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«**:
- `simpy_microservice.py` - ãƒ¡ã‚¤ãƒ³å‡¦ç†ãƒ•ãƒ­ãƒ¼å®Ÿè£…
- `per_second_metrics.py` - è©³ç´°ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†
- `resource_usage_summary.md` - æ€§èƒ½åˆ†æçµæœ