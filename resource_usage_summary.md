# SimPy マイクロサービス - 高負荷リソース使用量分析

**実行日時**: 2025-09-02  
**分析対象**: 50, 100, 200 req/s での各サーバー毎秒リソース使用量

---

## 🎯 シミュレーション結果サマリー

| 負荷レベル | 成功率 | 平均レスポンス | P95レスポンス | SLO(300ms) | 主要ボトルネック |
|-----------|--------|---------------|---------------|------------|----------------|
| **50 req/s**  | 99.0% | 0.571秒 | 0.736秒 | ❌ | S3(RAM:100%) |
| **100 req/s** | 98.0% | 1.152秒 | 1.521秒 | ❌ | Auth(CPU:99.3%, RAM:97.7%), S3(RAM:100%) |
| **200 req/s** | 50.1% | 15.353秒 | 28.488秒 | ❌ | 複数サーバーが限界（Auth, Service, S3など） |

---

## 🖥️ サーバー別負荷分析（200 req/s時）

### 🔴 **重度ボトルネック** (CPU >90% または RAM >90%)
- **Auth**: CPU 99.7%, RAM 100.0% - 認証処理が完全に飽和
- **Service**: CPU 98.6%, RAM 97.7% - サービス処理がほぼ限界
- **S3**: RAM 100.0% - ストレージサーバーのメモリ不足

### 🟡 **中度負荷** (CPU 70-90%)
- **APP1**: CPU 74.2%, RAM 74.7% - フロントエンド処理に負荷
- **Policy**: CPU 74.1% - ポリシー処理に負荷

### 🟢 **軽度負荷** (CPU <70%)
- **Nginx**: CPU 24.8% - ロードバランサーは余裕
- **DB**: CPU 22.2% - データベースは意外に余裕（30%確率アクセス）
- **Logger/ServiceHub/APP2**: 正常範囲

---

## 📊 毎秒リソース使用量データ

### 生成ファイル
1. **per_second_metrics_50rps_60s.json** (199KB)
   - 50 req/s での60秒間の全サーバー毎秒メトリクス
   - S3のRAM使用量が100%で推移

2. **per_second_metrics_100rps_60s.json** (200KB)
   - 100 req/s での60秒間の全サーバー毎秒メトリクス
   - AuthサーバーのCPU/RAM使用率が90%超え

3. **per_second_metrics_200rps_60s.json** (201KB)
   - 200 req/s での60秒間の全サーバー毎秒メトリクス
   - 複数サーバーでリソース枯渇、成功率50%に低下

### データ構造例（各サーバー・各秒）
```json
{
  "scenario": {
    "arrival_rate": 200,
    "simulation_time": 60,
    "timestamp": "2025-09-02T17:21:01.391512"
  },
  "servers": {
    "Auth": {
      "specs": {
        "threads": 4,
        "ram_gb": 32,
        "disk_queue_capacity": 4,
        "net_mbps": 1000
      },
      "per_second_data": {
        "30": {
          "cpu_usage_seconds": 3.8,
          "cpu_utilization_percent": 95.0,
          "ram_used_gb": 30.5,
          "ram_utilization_percent": 95.3,
          "disk_queue_length": 0,
          "active_requests": 12,
          "requests_started": 45,
          "requests_completed": 33
        }
      }
    }
  }
}
```

---

## 🎯 ボトルネック分析

### **Auth サーバー** - 最大の問題
- **問題**: 4スレッド、32GB RAMでは100 req/s以上で飽和
- **現象**: CPU使用率99.7%, RAM使用率100%
- **影響**: 認証待ちでリクエストが大量に滞留
- **対策**: スレッド数増加（4→16）、RAM増量（32→64GB）

### **S3 サーバー** - 継続的な問題  
- **問題**: 32GB RAMが全負荷で100%使用
- **現象**: 非同期ログ→S3処理でメモリ不足
- **影響**: ストレージ処理の遅延
- **対策**: RAM増量（32→128GB）、ディスクキュー調整

### **Service サーバー** - 200 req/s で限界
- **問題**: 16スレッド、64GB RAMが200 req/sで限界
- **現象**: DB呼び出し（30%確率）込みで処理能力不足
- **対策**: スレッド数増加、DB接続最適化

---

## 💡 スケーリング推奨

### **即座に対応が必要**
1. **Auth**: threads: 4→16, ram_gb: 32→64
2. **S3**: ram_gb: 32→128
3. **Service**: threads: 16→32

### **100 req/s 対応**
- Auth, S3の強化で100 req/sは98%成功率で処理可能

### **200 req/s 対応** 
- 全サーバーの大幅スケールアップが必要
- ロードバランサー追加、データベース分散も検討

---

## 📈 今後の活用

1. **キャパシティプランニング**: JSONデータで詳細な時系列分析
2. **リソース監視**: 本番環境での閾値設定（Auth CPU 80%でアラート等）
3. **スケーリング計画**: 段階的な負荷増加テストでの最適なリソース配分決定
4. **コスト最適化**: 必要最小限のリソースでSLO達成

---

**関連ファイル**:
- `per_second_metrics.py` - 毎秒メトリクス生成スクリプト
- `simpy_microservice.py` - 基本シミュレーションスクリプト  
- `*.json` - 各負荷レベルでの詳細メトリクス
